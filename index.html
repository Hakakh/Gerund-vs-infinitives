
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Tr√≤ ch∆°i h·ªçc ti·∫øng Anh: Gerund v√† Infinitive (To V, Bare V, V-ing) d√†nh cho h·ªçc sinh l·ªõp 7." />
    <title>H·ªçc Ng·ªØ Ph√°p: Gerund & Infinitive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Nunito', sans-serif;
      }
      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-6px); }
        75% { transform: translateX(6px); }
      }
      .animate-shake {
        animation: shake 0.5s ease-in-out;
      }
      .animate-fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
    </style>
</head>
<body>
    <noscript>B·∫°n c·∫ßn b·∫≠t JavaScript ƒë·ªÉ ch·∫°y ·ª©ng d·ª•ng n√†y.</noscript>
    <div id="root"></div>

    <script type="module">
      import React from 'https://esm.sh/react@18.2.0';
      import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';

      const { useState, useCallback, useMemo, useRef, useEffect } = React;

      const GameState = {
        Start: 0,
        TopicSelection: 1,
        Playing: 2,
        Congrats: 3,
      };

      const topics = {
        "ƒê·ªông t·ª´ ƒëi k√®m 'to V'": [
            { en: "I want to come to the party.", vi: "T·ªõ mu·ªën ƒë·∫øn b·ªØa ti·ªác. ü•≥" },
            { en: "We decided to go out for dinner.", vi: "Ch√∫ng t·ªõ ƒë√£ quy·∫øt ƒë·ªãnh ra ngo√†i ƒÉn t·ªëi. üçΩÔ∏è" },
            { en: "I hope to pass the exam.", vi: "T·ªõ hy v·ªçng s·∫Ω thi ƒë·∫≠u. üéì" },
            { en: "She plans to buy a new flat next year.", vi: "C√¥ ·∫•y d·ª± ƒë·ªãnh mua m·ªôt cƒÉn h·ªô m·ªõi v√†o nƒÉm sau. üè†" },
            { en: "They are learning to sing.", vi: "H·ªç ƒëang h·ªçc h√°t. üé§" },
            { en: "We promised not to be late.", vi: "Ch√∫ng t·ªõ h·ª©a s·∫Ω kh√¥ng ƒë·∫øn mu·ªôn. ‚è∞" },
            { en: "We agree to start early.", vi: "Ch√∫ng t·ªõ ƒë·ªìng √Ω xu·∫•t ph√°t s·ªõm. ‚òÄÔ∏è" },
            { en: "I need to go to school today.", vi: "H√¥m nay t·ªõ c·∫ßn ƒë·∫øn tr∆∞·ªùng. üè´" },
            { en: "I tried to pass the exam.", vi: "T·ªõ ƒë√£ c·ªë g·∫Øng v∆∞·ª£t qua k·ª≥ thi. üí™" },
            { en: "I would like to see her tonight.", vi: "T·ªõ mu·ªën g·∫∑p c√¥ ·∫•y t·ªëi nay. ‚ú®" },
            { en: "He offered to help me with my homework.", vi: "C·∫≠u ·∫•y ƒë·ªÅ ngh·ªã gi√∫p t·ªõ l√†m b√†i t·∫≠p v·ªÅ nh√†. üìö" },
            { en: "She refused to answer the question.", vi: "C√¥ ·∫•y t·ª´ ch·ªëi tr·∫£ l·ªùi c√¢u h·ªèi. ü§ê" },
            { en: "I expect to see you there.", vi: "T·ªõ mong s·∫Ω g·∫∑p c·∫≠u ·ªü ƒë√≥. üëã" },
            { en: "He managed to open the door.", vi: "Anh ·∫•y ƒë√£ xoay x·ªü m·ªü ƒë∆∞·ª£c c√°i c·ª≠a. üö™" },
            { en: "I can't afford to buy that bike.", vi: "T·ªõ kh√¥ng ƒë·ªß ti·ªÅn mua chi·∫øc xe ƒë·∫°p ƒë√≥. üö≤" },
            { en: "She seems to be tired.", vi: "C√¥ ·∫•y d∆∞·ªùng nh∆∞ ƒëang m·ªát. üò¥" },
            { en: "They arranged to meet at five p.m.", vi: "H·ªç ƒë√£ s·∫Øp x·∫øp g·∫∑p nhau l√∫c 5 gi·ªù chi·ªÅu. üïî" },
            { en: "I am happy to hear that news.", vi: "T·ªõ r·∫•t vui khi nghe tin ƒë√≥. üòä" },
            { en: "It is easy to learn English.", vi: "H·ªçc ti·∫øng Anh r·∫•t d·ªÖ. üî§" },
            { en: "She was surprised to see him.", vi: "C√¥ ·∫•y ng·∫°c nhi√™n khi th·∫•y anh ·∫•y. üò≤" },
            { en: "My dad taught me how to ride a bike.", vi: "B·ªë d·∫°y t·ªõ c√°ch ƒëi xe ƒë·∫°p. üö≤" }
        ],
        "C·∫•u tr√∫c 'Object + to V'": [
            { en: "I asked him to leave early.", vi: "T·ªõ ƒë√£ b·∫£o c·∫≠u ·∫•y v·ªÅ s·ªõm. üè†" },
            { en: "My mother told me to clean my room.", vi: "M·∫π b·∫£o t·ªõ d·ªçn ph√≤ng. üßπ" },
            { en: "He advised me to apply at once.", vi: "Ch√∫ ·∫•y khuy√™n t·ªõ n·ªôp ƒë∆°n ngay l·∫≠p t·ª©c. üìù" },
            { en: "She allowed me to use her car.", vi: "C√¥ ·∫•y cho ph√©p t·ªõ d√πng xe c·ªßa c√¥ ·∫•y. üöó" },
            { en: "I want him to come to the party.", vi: "T·ªõ mu·ªën c·∫≠u ·∫•y ƒë·∫øn b·ªØa ti·ªác. üéâ" },
            { en: "They invited us to stay for dinner.", vi: "H·ªç m·ªùi ch√∫ng t·ªõ ·ªü l·∫°i ƒÉn t·ªëi. üçó" },
            { en: "Please remind me to buy milk.", vi: "L√†m ∆°n nh·∫Øc t·ªõ mua s·ªØa nh√©. ü•õ" },
            { en: "The teacher encouraged us to study hard.", vi: "Gi√°o vi√™n khuy·∫øn kh√≠ch ch√∫ng t·ªõ h·ªçc chƒÉm ch·ªâ. ‚úçÔ∏è" }
        ],
        "ƒê·ªông t·ª´ nguy√™n m·∫´u (Bare V)": [
            { en: "She can speak English very well.", vi: "C√¥ ·∫•y c√≥ th·ªÉ n√≥i ti·∫øng Anh r·∫•t t·ªët. üó£Ô∏è" },
            { en: "You must try the new restaurant.", vi: "B·∫°n ph·∫£i th·ª≠ nh√† h√†ng m·ªõi ƒë√≥ nh√©. üçî" },
            { en: "I must go now.", vi: "T·ªõ ph·∫£i ƒëi ngay b√¢y gi·ªù. üèÉ" },
            { en: "You really should study more.", vi: "C·∫≠u th·ª±c s·ª± n√™n h·ªçc b√†i nhi·ªÅu h∆°n. üìñ" },
            { en: "They will be late.", vi: "H·ªç s·∫Ω b·ªã mu·ªôn ƒë·∫•y. ‚è≥" },
            { en: "It may rain at the weekend.", vi: "Cu·ªëi tu·∫ßn tr·ªùi c√≥ th·ªÉ s·∫Ω m∆∞a. üåßÔ∏è" },
            { en: "We could go to the cinema.", vi: "Ch√∫ng ta c√≥ th·ªÉ ƒëi xem phim. üé¨" },
            { en: "My dad lets me drive his car.", vi: "B·ªë cho ph√©p t·ªõ l√°i xe c·ªßa b·ªë. üèéÔ∏è" },
            { en: "Let's go.", vi: "Ch√∫ng ta ƒëi th√¥i n√†o. üöÄ" },
            { en: "The teacher made us write an essay.", vi: "Gi√°o vi√™n b·∫Øt ch√∫ng t·ªõ vi·∫øt m·ªôt b√†i ti·ªÉu lu·∫≠n. üìÑ" },
            { en: "The music made him want to dance.", vi: "√Çm nh·∫°c khi·∫øn anh ·∫•y mu·ªën nh·∫£y m√∫a. üíÉ" },
            { en: "Have Mrs Hansen come in please.", vi: "L√†m ∆°n m·ªùi b√† Hansen v√†o. üö™" },
            { en: "I saw her cross the road.", vi: "T·ªõ ƒë√£ nh√¨n th·∫•y c√¥ ·∫•y bƒÉng qua ƒë∆∞·ªùng. üõ£Ô∏è" },
            { en: "We saw him leave the house.", vi: "Ch√∫ng t·ªõ th·∫•y anh ·∫•y r·ªùi kh·ªèi nh√†. üè†" },
            { en: "She heard the baby cry in the next room.", vi: "C√¥ ·∫•y nghe th·∫•y em b√© kh√≥c ·ªü ph√≤ng b√™n. üë∂" },
            { en: "I watch them do gardening all afternoon.", vi: "T·ªõ quan s√°t h·ªç l√†m v∆∞·ªùn c·∫£ bu·ªïi chi·ªÅu. üåª" },
            { en: "He helped me wash my car.", vi: "Anh ·∫•y ƒë√£ gi√∫p t·ªõ r·ª≠a xe. üßΩ" },
            { en: "You had better work.", vi: "T·ªët h∆°n h·∫øt l√† c·∫≠u n√™n l√†m vi·ªác ƒëi. üí™" },
            { en: "We would rather work than play.", vi: "Ch√∫ng t·ªõ th√† l√†m vi·ªác c√≤n h∆°n l√† ch∆°i. üõ†Ô∏è" },
            { en: "Why not take a holiday?", vi: "Sao kh√¥ng ƒëi ngh·ªâ m√°t ƒëi nh·ªâ? üèñÔ∏è" }
        ],
        "Danh ƒë·ªông t·ª´ (V-ing)": [
            { en: "I enjoy reading books in the library.", vi: "T·ªõ th√≠ch ƒë·ªçc s√°ch trong th∆∞ vi·ªán. üìö" },
            { en: "Have you finished doing your homework?", vi: "C·∫≠u ƒë√£ l√†m xong b√†i t·∫≠p v·ªÅ nh√† ch∆∞a? ‚úÖ" },
            { en: "She practices speaking English every day.", vi: "C√¥ ·∫•y luy·ªán n√≥i ti·∫øng Anh m·ªói ng√†y. üó£Ô∏è" },
            { en: "We should avoid eating too much sugar.", vi: "Ch√∫ng ta n√™n tr√°nh ƒÉn qu√° nhi·ªÅu ƒë∆∞·ªùng. üç¨" },
            { en: "Do you mind opening the window?", vi: "B·∫°n c√≥ phi·ªÅn m·ªü gi√∫p t·ªõ c√°i c·ª≠a s·ªï kh√¥ng? ü™ü" },
            { en: "He suggested going to the cinema.", vi: "C·∫≠u ·∫•y ƒë·ªÅ ngh·ªã ƒëi xem phim. üìΩÔ∏è" },
            { en: "He kept working although he was tired.", vi: "Anh ·∫•y v·∫´n ti·∫øp t·ª•c l√†m vi·ªác d√π ƒë√£ m·ªát. üèóÔ∏è" },
            { en: "I dislike waiting for buses.", vi: "T·ªõ kh√¥ng th√≠ch vi·ªác ph·∫£i ch·ªù xe bu√Ωt. üöå" },
            { en: "I miss playing with my old friends.", vi: "T·ªõ nh·ªõ nh·ªØng l·∫ßn ch∆°i ƒë√πa c√πng b·∫°n c≈©. üßë‚Äçü§ù‚Äçüßë" },
            { en: "He denied breaking the vase.", vi: "C·∫≠u ·∫•y ph·ªß nh·∫≠n vi·ªác l√†m v·ª° b√¨nh hoa. üè∫" },
            { en: "I like watching TV.", vi: "T·ªõ th√≠ch xem TV. üì∫" },
            { en: "She loves swimming in the summer.", vi: "C√¥ ·∫•y y√™u th√≠ch b∆°i l·ªôi v√†o m√πa h√®. üèä" },
            { en: "He hates getting up early.", vi: "C·∫≠u ·∫•y gh√©t ph·∫£i d·∫≠y s·ªõm. üò¥" },
            { en: "I prefer driving to traveling by train.", vi: "T·ªõ th√≠ch l√°i xe h∆°n l√† ƒëi t√†u h·ªèa. üöó" },
            { en: "I look forward to meeting you.", vi: "T·ªõ r·∫•t mong ƒë∆∞·ª£c g·∫∑p c·∫≠u. üëã" },
            { en: "I am used to getting up early.", vi: "T·ªõ ƒë√£ quen v·ªõi vi·ªác d·∫≠y s·ªõm r·ªìi. ‚òÄÔ∏è" },
            { en: "I can't stand waiting in the rain.", vi: "T·ªõ kh√¥ng th·ªÉ ch·ªãu ƒë·ª±ng ƒë∆∞·ª£c vi·ªác ch·ªù ƒë·ª£i d∆∞·ªõi m∆∞a. üåßÔ∏è" },
            { en: "My mom is busy cooking dinner.", vi: "M·∫π t·ªõ ƒëang b·∫≠n n·∫•u b·ªØa t·ªëi. üç≥" },
            { en: "It is no use worrying about it.", vi: "Lo l·∫Øng v·ªÅ vi·ªác ƒë√≥ c≈©ng v√¥ √≠ch th√¥i. üòü" },
            { en: "Let's go shopping.", vi: "Ch√∫ng m√¨nh ƒëi mua s·∫Øm ƒëi. üõçÔ∏è" },
            { en: "They go swimming every Sunday.", vi: "H·ªç ƒëi b∆°i v√†o m·ªói Ch·ªß nh·∫≠t. üèä‚Äç‚ôÇÔ∏è" },
            { en: "He is good at playing football.", vi: "C·∫≠u ·∫•y gi·ªèi ch∆°i b√≥ng ƒë√°. ‚öΩ" },
            { en: "Thank you for helping me.", vi: "C·∫£m ∆°n v√¨ ƒë√£ gi√∫p t·ªõ. ‚ù§Ô∏è" },
            { en: "She left without saying goodbye.", vi: "C√¥ ·∫•y r·ªùi ƒëi m√† kh√¥ng ch√†o t·∫°m bi·ªát. üëã" }
        ],
        "ƒê·ªông t·ª´ thay ƒë·ªïi nghƒ©a": [
            { en: "Please stop talking.", vi: "L√†m ∆°n ng·ª´ng n√≥i chuy·ªán ƒëi (d·ª´ng h·∫≥n). ü§´" },
            { en: "I stopped to buy a newspaper.", vi: "T·ªõ d·ª´ng l·∫°i ƒë·ªÉ mua b√°o (m·ª•c ƒë√≠ch). üì∞" },
            { en: "I remember meeting him somewhere.", vi: "T·ªõ nh·ªõ l√† ƒë√£ g·∫∑p anh ·∫•y ·ªü ƒë√¢u ƒë√≥ r·ªìi (qu√° kh·ª©). ü§î" },
            { en: "Remember to lock the door.", vi: "Nh·ªõ ph·∫£i kh√≥a c·ª≠a nh√© (ch∆∞a l√†m). üîê" },
            { en: "I will never forget visiting Paris.", vi: "T·ªõ s·∫Ω kh√¥ng bao gi·ªù qu√™n l·∫ßn ƒëi thƒÉm Paris. üóº" },
            { en: "Don't forget to buy milk.", vi: "ƒê·ª´ng qu√™n ph·∫£i mua s·ªØa ƒë·∫•y. ü•õ" },
            { en: "You should try eating this cake.", vi: "C·∫≠u n√™n th·ª≠ ƒÉn c√°i b√°nh n√†y xem (th·ª≠ nghi·ªám). üç∞" },
            { en: "I tried to open the jar but it was tight.", vi: "T·ªõ ƒë√£ c·ªë g·∫Øng m·ªü c√°i l·ªç nh∆∞ng n√≥ ch·∫∑t qu√°. üçØ" },
            { en: "He regrets leaving school early.", vi: "Anh ·∫•y h·ªëi h·∫≠n v√¨ ƒë√£ b·ªè h·ªçc s·ªõm. üòî" },
            { en: "I regret to tell you that you failed.", vi: "T√¥i l·∫•y l√†m ti·∫øc ph·∫£i th√¥ng b√°o r·∫±ng b·∫°n ƒë√£ tr∆∞·ª£t. üìâ" },
            { en: "You need to work harder.", vi: "C·∫≠u c·∫ßn l√†m vi·ªác chƒÉm h∆°n. üí™" },
            { en: "This house needs painting.", vi: "Ng√¥i nh√† n√†y c·∫ßn ƒë∆∞·ª£c s∆°n l·∫°i (b·ªã ƒë·ªông). üè†" },
            { en: "I saw him steal the bike.", vi: "T·ªõ th·∫•y anh ta tr·ªôm xe (to√†n b·ªô qu√° tr√¨nh). üö≤" },
            { en: "I saw him waiting for the bus.", vi: "T·ªõ th·∫•y anh ·∫•y ƒëang ch·ªù xe bu√Ωt (m·ªôt ph·∫ßn h√†nh ƒë·ªông). üöå" }
        ]
      };

      const useSpeechSynthesis = () => {
        const [isSpeaking, setIsSpeaking] = useState(false);
        const [voices, setVoices] = useState([]);
        const utteranceRef = useRef(null);

        const updateVoices = useCallback(() => {
          if ('speechSynthesis' in window) {
            const availableVoices = window.speechSynthesis.getVoices();
            const englishVoices = availableVoices.filter(voice => voice.lang.startsWith('en'));
            setVoices(englishVoices);
          }
        }, []);

        useEffect(() => {
          if ('speechSynthesis' in window) {
            updateVoices();
            window.speechSynthesis.onvoiceschanged = updateVoices;
            return () => {
              if (window.speechSynthesis) {
                window.speechSynthesis.onvoiceschanged = null;
              }
            }
          }
        }, [updateVoices]);

        const cancel = useCallback(() => {
          if (window.speechSynthesis) {
              window.speechSynthesis.cancel();
          }
        }, []);

        const speak = useCallback((text, options = {}) => {
          cancel();
          if (!('speechSynthesis' in window)) {
              if (options.onEnd) options.onEnd();
              return;
          }
          const { rate = 1.0, onBoundary, onEnd, voice } = options;
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = 'en-US';
          utterance.rate = rate;
          if (voice) utterance.voice = voice;
          utteranceRef.current = utterance;

          utterance.onstart = () => setIsSpeaking(true);
          
          if (onBoundary) {
            utterance.onboundary = (event) => {
              if (event.name === 'word') {
                const words = text.split(' ');
                let cumulativeLength = 0;
                for (let i = 0; i < words.length; i++) {
                  cumulativeLength += words[i].length + 1;
                  if (event.charIndex < cumulativeLength) {
                      onBoundary(i);
                      return;
                  }
                }
              }
            };
          }

          utterance.onend = () => {
            setIsSpeaking(false);
            utteranceRef.current = null;
            if (onEnd) onEnd();
          };

          utterance.onerror = (event) => {
            setIsSpeaking(false);
            utteranceRef.current = null;
            if (onEnd) onEnd();
          };
          
          setTimeout(() => {
              window.speechSynthesis.speak(utterance);
          }, 50);
        }, [cancel]);

        return { speak, cancel, isSpeaking, voices };
      };

      const Fireworks = () => {
        const canvasRef = useRef(null);
        const animationFrameId = useRef();
        const particles = useRef([]);

        const createParticle = (x, y) => {
          const angle = Math.random() * Math.PI * 2;
          const speed = Math.random() * 6 + 2;
          return {
            x, y,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            color: `hsl(${Math.random() * 360}, 100%, 70%)`,
            size: Math.random() * 3 + 1,
            life: 1,
            fade: 0.02,
          };
        };

        const createExplosion = () => {
          if (!canvasRef.current) return;
          const x = Math.random() * canvasRef.current.width;
          const y = Math.random() * canvasRef.current.height / 2;
          for (let i = 0; i < 50; i++) {
            particles.current.push(createParticle(x, y));
          }
        };

        const animate = () => {
          if (!canvasRef.current) return;
          const ctx = canvasRef.current.getContext('2d');
          if (!ctx) return;
          ctx.globalCompositeOperation = 'source-over';
          ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
          ctx.fillRect(0, 0, canvasRef.current.width, canvasRef.current.height);
          ctx.globalCompositeOperation = 'lighter';
          particles.current = particles.current.filter(p => p.life > 0);
          particles.current.forEach(p => {
            p.x += p.vx; p.y += p.vy;
            p.vy += 0.05; p.life -= p.fade;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            ctx.fillStyle = `hsla(${p.color.match(/\d+/)?.[0]}, 100%, 70%, ${p.life})`;
            ctx.fill();
          });
          animationFrameId.current = requestAnimationFrame(animate);
        };

        useEffect(() => {
          const canvas = canvasRef.current;
          if (canvas) {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const handleResize = () => {
              canvas.width = window.innerWidth;
              canvas.height = window.innerHeight;
            };
            window.addEventListener('resize', handleResize);
            const intervalIds = [
                setInterval(createExplosion, 800),
                setTimeout(() => setInterval(createExplosion, 1200), 400)
            ];
            animate();
            return () => {
              window.removeEventListener('resize', handleResize);
              if (animationFrameId.current) cancelAnimationFrame(animationFrameId.current);
              intervalIds.forEach(id => typeof id === 'number' ? clearInterval(id) : clearTimeout(id));
              particles.current = [];
            };
          }
        }, []);

        return React.createElement('canvas', { ref: canvasRef, className: "fixed top-0 left-0 w-full h-full pointer-events-none z-50" });
      };

      const TopicCongratsScreen = ({ playerName, topicName, correctCount, totalCount, onPlayAgain, onChooseAnotherTopic }) => {
        return React.createElement('div', { className: "relative flex flex-col items-center gap-6 text-center p-4 animate-fade-in" },
          React.createElement(Fireworks),
          React.createElement('div', { className: "text-2xl sm:text-3xl md:text-4xl text-green-600 font-extrabold" },
            React.createElement('p', null, "Tuy·ªát v·ªùi ", React.createElement('strong', { className: "text-purple-600" }, playerName), "!"),
            React.createElement('p', { className: "mt-2" }, `B·∫°n ƒë√£ chinh ph·ª•c ƒë∆∞·ª£c "${topicName}".`)
          ),
          React.createElement('p', { className: "text-xl sm:text-2xl text-slate-700 font-semibold" }, `ƒê·ªô ch√≠nh x√°c: ${correctCount}/${totalCount} c√¢u.`),
          React.createElement('div', { className: "flex flex-col sm:flex-row gap-4 mt-6 w-full max-w-md" },
            React.createElement('button', {
              onClick: onPlayAgain,
              className: "w-full p-4 text-xl rounded-2xl bg-blue-500 text-white font-bold transform hover:scale-105 hover:bg-blue-600 transition-all shadow-lg"
            }, "Ch∆°i l·∫°i"),
            React.createElement('button', {
              onClick: onChooseAnotherTopic,
              className: "w-full p-4 text-xl rounded-2xl bg-orange-500 text-white font-bold transform hover:scale-105 hover:bg-orange-600 transition-all shadow-lg"
            }, "Ch·ªß ƒë·ªÅ kh√°c")
          )
        );
      };

      const StartScreen = ({ onStart }) => {
        const [name, setName] = useState('');
        const handleStartClick = () => {
          if (name.trim()) onStart(name.trim());
          else alert('Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n!');
        };
        const handleKeyPress = (e) => { if (e.key === 'Enter') handleStartClick(); };

        return React.createElement('div', { className: "flex flex-col items-center gap-6 animate-fade-in" },
          React.createElement('p', { className: "text-slate-600 font-semibold mb-2" }, "H·ªçc Gerund & Infinitive qua √¢m thanh v√† h√¨nh ·∫£nh"),
          React.createElement('input', {
            type: "text",
            value: name,
            onChange: (e) => setName(e.target.value),
            onKeyPress: handleKeyPress,
            placeholder: "Nh·∫≠p t√™n c·ªßa b·∫°n...",
            className: "font-nunito text-lg sm:text-xl p-3 px-5 rounded-2xl border-2 border-purple-400 text-center w-full max-w-sm focus:outline-none focus:ring-4 focus:ring-purple-300 transition-shadow shadow-inner"
          }),
          React.createElement('button', {
            onClick: handleStartClick,
            className: "p-4 px-10 text-xl sm:text-2xl rounded-2xl w-full max-w-sm bg-green-500 text-white font-bold transform hover:scale-105 hover:bg-green-600 active:scale-100 transition-all shadow-lg hover:shadow-xl"
          }, "V√†o h·ªçc ngay")
        );
      };

      const topicColors = [
        'from-indigo-500 to-indigo-600', 'from-teal-500 to-teal-600', 'from-amber-500 to-amber-600',
        'from-rose-500 to-rose-600', 'from-cyan-500 to-cyan-600',
      ];
      const TopicSelectionScreen = ({ topics, onSelectTopic }) => {
        return React.createElement('div', { className: "flex flex-col items-center gap-4 w-full animate-fade-in" },
          React.createElement('h2', { className: "text-2xl sm:text-3xl font-bold mb-4 text-slate-700" }, "Ch·ªçn n·ªôi dung mu·ªën luy·ªán t·∫≠p:"),
          React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-5 w-full max-w-2xl" },
            topics.map((topic, index) => (
              React.createElement('button', {
                key: topic,
                onClick: () => onSelectTopic(topic),
                className: `p-4 text-lg text-white font-bold rounded-2xl transform hover:-translate-y-1 transition-all shadow-lg hover:shadow-xl bg-gradient-to-br ${topicColors[index % topicColors.length]}`
              }, topic)
            ))
          )
        );
      };

      const shuffle = (array) => {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
      };

      const pastelColors = [
        'bg-sky-200 border-sky-400 text-sky-800 hover:bg-sky-300',
        'bg-emerald-200 border-emerald-400 text-emerald-800 hover:bg-emerald-300',
        'bg-rose-200 border-rose-400 text-rose-800 hover:bg-rose-300',
        'bg-amber-200 border-amber-400 text-amber-800 hover:bg-amber-300',
        'bg-violet-200 border-violet-400 text-violet-800 hover:bg-violet-300',
        'bg-teal-200 border-teal-400 text-teal-800 hover:bg-teal-300',
      ];

      const GameScreen = ({ sentences, onTopicComplete, onChooseAnotherTopic }) => {
        const [currentIndex, setCurrentIndex] = useState(0);
        const [currentWords, setCurrentWords] = useState([]);
        const [shuffledWords, setShuffledWords] = useState([]);
        const [playerAnswer, setPlayerAnswer] = useState([]);
        const [mistakeCount, setMistakeCount] = useState(0);
        const [incorrectWord, setIncorrectWord] = useState(null);
        const [message, setMessage] = useState(null);
        const [score, setScore] = useState(0);
        const [correctlyAnswered, setCorrectlyAnswered] = useState(0);
        const [isSentenceDone, setIsSentenceDone] = useState(false);
        const [highlightedIndex, setHighlightedIndex] = useState(-1);
        const allowSecondPlay = useRef(true);
        const { speak, cancel, isSpeaking, voices } = useSpeechSynthesis();
        const [selectedVoiceURI, setSelectedVoiceURI] = useState(null);
        
        const selectedVoice = useMemo(() => {
          if (!voices || voices.length === 0) return null;
          return selectedVoiceURI ? voices.find(v => v.voiceURI === selectedVoiceURI) : (voices.find(v => v.name.includes('US')) || voices[0]);
        }, [voices, selectedVoiceURI]);

        useEffect(() => {
            if (voices.length > 0 && !selectedVoiceURI) {
                const def = voices.find(v => v.name.includes('US')) || voices[0];
                setSelectedVoiceURI(def.voiceURI);
            }
        }, [voices]);

        const currentSentence = useMemo(() => sentences[currentIndex], [sentences, currentIndex]);

        const startNewSentence = useCallback(() => {
          if (currentIndex >= sentences.length) {
            onTopicComplete(correctlyAnswered, sentences.length);
            return;
          }
          setIsSentenceDone(false); setPlayerAnswer([]); setMistakeCount(0); setMessage(null); setHighlightedIndex(-1);
          const cleanSentence = sentences[currentIndex].en.replace(/[.!?]$/, '');
          const words = cleanSentence.split(/\s+/);
          setCurrentWords(words); setShuffledWords(shuffle(words));
          allowSecondPlay.current = true;
          const speakOptions = { rate: 0.85, voice: selectedVoice };
          speak(sentences[currentIndex].en, {
              ...speakOptions,
              onEnd: () => {
                  if (allowSecondPlay.current) {
                      setTimeout(() => { if (allowSecondPlay.current) speak(sentences[currentIndex].en, speakOptions); }, 600);
                  }
              }
          });
        }, [currentIndex, sentences, onTopicComplete, correctlyAnswered, speak, selectedVoice]);

        useEffect(() => { startNewSentence(); return () => { allowSecondPlay.current = false; cancel(); }; }, [currentIndex, startNewSentence]);

        const handleListenAgain = () => {
          if (currentSentence) { allowSecondPlay.current = false; speak(currentSentence.en, { rate: 0.85, voice: selectedVoice }); }
        };

        const handleWordClick = (word, index) => {
          if (isSentenceDone) return;
          allowSecondPlay.current = false;
          const correctWord = currentWords[playerAnswer.length];
          if (word === correctWord) {
            const nextAnswer = [...playerAnswer, word];
            setPlayerAnswer(nextAnswer);
            setShuffledWords(prev => {
              const newArr = [...prev];
              const wordIdx = newArr.findIndex((w, i) => w === word && i === index);
              if (wordIdx > -1) newArr[wordIdx] = '';
              return newArr;
            });
            if (nextAnswer.length === currentWords.length) {
              setIsSentenceDone(true);
              if (mistakeCount <= 1) {
                setScore(s => s + 10); setCorrectlyAnswered(c => c + 1);
                setMessage({ text: 'R·∫•t t·ªët! +10 ƒëi·ªÉm.', type: 'success' });
              } else {
                setMessage({ text: `Ho√†n th√†nh (Sai ${mistakeCount} l·∫ßn).`, type: 'info' });
              }
              speak(currentSentence.en, { 
                  voice: selectedVoice,
                  onBoundary: (wordIndex) => setHighlightedIndex(wordIndex),
                  onEnd: () => { setHighlightedIndex(-1); setTimeout(() => setCurrentIndex(prev => prev + 1), 1800); }
              });
            }
          } else {
            setMistakeCount(prev => prev + 1);
            setIncorrectWord(`${word}-${index}`);
            setTimeout(() => setIncorrectWord(null), 500);
          }
        };

        return React.createElement('div', { className: "flex flex-col items-center gap-2 w-full animate-fade-in" },
          React.createElement('div', { className: "w-full text-center bg-purple-100/70 p-4 rounded-2xl border-2 border-purple-200" },
            React.createElement('div', { className: "text-xl sm:text-2xl text-purple-900 font-bold mb-1" }, `‚Äú${currentSentence?.vi}‚Äù`)
          ),
          React.createElement('div', { className: "text-2xl sm:text-3xl font-bold mt-4 mb-2 min-h-[120px] bg-slate-50 p-6 rounded-2xl shadow-inner border-2 border-dashed border-slate-200 w-full flex items-center justify-center flex-wrap gap-x-3 gap-y-4" },
            isSentenceDone ? 
              currentSentence.en.split(/\s+/).map((word, index) => React.createElement('span', { key: index, className: `inline-block px-1 rounded-md transition-all duration-200 ${highlightedIndex === index ? 'bg-yellow-300 text-black scale-110' : 'bg-transparent text-slate-800'}`}, word)) :
              currentWords.map((_, index) => React.createElement('div', { key: index, className: `min-h-[50px] min-w-[80px] flex items-center justify-center text-xl font-semibold px-4 py-2 rounded-xl ${playerAnswer[index] ? 'bg-purple-200 border-2 border-purple-500 text-purple-900 shadow-sm' : 'bg-slate-200 border-2 border-slate-300 opacity-50'}`}, playerAnswer[index] || ""))
          ),
          React.createElement('div', { className: "min-h-[28px] text-lg font-bold" },
            message && React.createElement('p', { className: `${message.type === 'success' ? 'text-green-600' : 'text-blue-500'}` }, message.text)
          ),
          React.createElement('div', { className: "flex flex-wrap justify-center gap-3 mt-2 mb-6 w-full min-h-[100px]" },
            shuffledWords.map((word, index) => {
              const isUsed = word === '';
              const isIncorrect = incorrectWord === `${word}-${index}`;
              const pastelColor = pastelColors[index % pastelColors.length];
              return React.createElement('button', {
                key: index,
                onClick: () => handleWordClick(word, index),
                disabled: isUsed || isSentenceDone,
                className: `text-lg sm:text-xl font-bold py-3 px-6 rounded-2xl border-b-4 transition-all duration-150 transform active:translate-y-0.5 active:border-b-2 ${isUsed ? 'opacity-0 pointer-events-none' : 'opacity-100'} ${isIncorrect ? 'border-red-500 animate-shake bg-red-100 text-red-600' : `${pastelColor} border-current hover:-translate-y-1 hover:shadow-md`} ${isSentenceDone ? 'cursor-not-allowed' : ''}`
              }, word);
            })
          ),
          React.createElement('div', { className: "flex flex-wrap justify-center items-center gap-4 my-2" },
            React.createElement('button', { onClick: handleListenAgain, disabled: isSentenceDone || isSpeaking, className: "py-3 px-8 text-lg font-bold bg-purple-600 text-white rounded-xl shadow-md transform hover:-translate-y-1 transition-all disabled:opacity-50" }, "Nghe l·∫°i üîä"),
             React.createElement('select', {
                  value: selectedVoiceURI || '',
                  onChange: (e) => setSelectedVoiceURI(e.target.value),
                  disabled: isSpeaking,
                  className: "py-3 px-5 text-base font-bold bg-white border-2 border-purple-300 rounded-xl shadow-sm focus:ring-2 focus:ring-purple-400 outline-none"
                },
                voices.map(v => React.createElement('option', { key: v.voiceURI, value: v.voiceURI }, v.name))
            ),
            React.createElement('button', { onClick: onChooseAnotherTopic, className: "py-3 px-8 text-lg font-bold bg-gray-100 text-slate-700 border-2 border-slate-200 rounded-xl shadow-sm transform hover:-translate-y-1 transition-all" }, "ƒê·ªïi ch·ªß ƒë·ªÅ")
          ),
          React.createElement('div', { className: "text-xl font-bold text-slate-600 mt-6 bg-slate-100 px-6 py-2 rounded-full" }, `ƒêi·ªÉm: ${score} | Ti·∫øn tr√¨nh: ${currentIndex + 1}/${sentences.length}`)
        );
      };
      
      const App = () => {
        const [gameState, setGameState] = useState(GameState.Start);
        const [playerName, setPlayerName] = useState('');
        const [selectedTopic, setSelectedTopic] = useState('');
        const [topicSentences, setTopicSentences] = useState([]);
        const [lastScore, setLastScore] = useState({ correct: 0, total: 0 });

        const handleStart = (name) => { setPlayerName(name); setGameState(GameState.TopicSelection); };
        const handleSelectTopic = (topicName) => { setSelectedTopic(topicName); setTopicSentences(topics[topicName]); setGameState(GameState.Playing); };
        const handleTopicComplete = (correct, total) => { setLastScore({ correct, total }); setGameState(GameState.Congrats); };
        const handlePlayAgain = () => setGameState(GameState.Playing);
        const handleChooseAnotherTopic = () => { setSelectedTopic(''); setGameState(GameState.TopicSelection); };

        const renderScreen = () => {
          switch (gameState) {
            case GameState.Start: return React.createElement(StartScreen, { onStart: handleStart });
            case GameState.TopicSelection: return React.createElement(TopicSelectionScreen, { topics: Object.keys(topics), onSelectTopic: handleSelectTopic });
            case GameState.Playing: return React.createElement(GameScreen, { key: selectedTopic, sentences: topicSentences, onTopicComplete: handleTopicComplete, onChooseAnotherTopic: handleChooseAnotherTopic });
            case GameState.Congrats: return React.createElement(TopicCongratsScreen, { playerName, topicName: selectedTopic, correctCount: lastScore.correct, totalCount: lastScore.total, onPlayAgain, onChooseAnotherTopic });
            default: return React.createElement(StartScreen, { onStart: handleStart });
          }
        };

        return React.createElement('div', { className: "bg-gradient-to-br from-indigo-50 to-purple-100 min-h-screen w-full flex justify-center items-center p-4" },
          React.createElement('main', { className: "container mx-auto text-center p-8 max-w-4xl w-full bg-white/95 backdrop-blur-md rounded-[2.5rem] shadow-2xl border-4 border-white" },
            React.createElement('h1', { className: "text-4xl sm:text-5xl font-extrabold text-indigo-700 mb-2 tracking-tight" }, "NG·ªÆ PH√ÅP L·ªöP 7"),
            React.createElement('h2', { className: "text-lg sm:text-xl text-indigo-400 font-bold mb-8 uppercase tracking-widest" }, "Gerund & Infinitive Mastery"),
            renderScreen()
          )
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(React.createElement(App));
    </script>
</body>
</html>
